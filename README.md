# 虚拟足鞋适配系统

## 项目简介

虚拟足鞋适配系统是一个基于Python开发的工具，用于模拟和分析足部与鞋内腔之间的适配情况。该系统通过导入足部三维扫描模型、鞋内腔模型、PPT数据以及面料顶破实验数据，计算并可视化足鞋之间的干涉和压力分布，提供专业的足鞋适配分析。

## 系统架构

系统由以下主要模块组成：

### 1. 数据模型模块 (`models.py`)
- `FootModel`：足部模型类，处理足部三维扫描数据
- `ShoeLast`：鞋内腔模型类，处理鞋内腔模型数据
- `PPTData`：PPT数据类，处理全足疼痛敏感性数据

### 2. 配准模块 (`registration.py`)
- 实现模型之间的配准功能
- 处理特征点对齐
- 坐标变换和数据映射

### 3. 适配分析模块 (`fitting_process.py`)
- 计算足部与鞋内腔之间的干涉
- 分析压力分布
- 生成适配评估结果

### 4. 可视化模块 (`visualization.py`)
- 3D模型渲染
- 压力分布云图显示
- 交互式视图控制

### 5. 用户界面模块 (`gui.py`)
- 基于PyQt5的图形界面
- 左侧控制面板
- 右侧四分屏显示区域
- 实时日志显示

### 6. 主程序模块 (`main.py`)
- 系统初始化和协调
- 数据加载和处理
- 分析流程控制

## 功能特点

1. **数据导入**
   - 支持WRL格式的足部三维扫描模型
   - 支持带有顶点组信息的鞋内腔模型
   - 支持Excel格式的PPT数据
   - 支持面料顶破实验数据

2. **模型对齐**
   - 基于特征点的初始对齐
   - 精确的模型配准
   - 保持足部模型坐标系不变

3. **适配分析**
   - 鞋底区域形态分析
   - 足部模型变形计算
   - 干涉分析和压力计算
   - PPT数据映射和插值

4. **可视化显示**
   - 四视图显示（PPT分布、基础适配、材质优化、最终结果）
   - 交互式3D视图控制
   - 压力分布云图
   - 实时日志显示

## 环境要求

- Python 3.6+
- PyQt5
- VTK
- NumPy
- SciPy
- Pandas
- Trimesh

## 使用说明

1. **启动程序**
   ```bash
   python start.py
   ```

2. **数据准备**
   - 准备足部三维扫描模型（WRL格式）
   - 准备鞋内腔模型（OBJ格式）
   - 准备PPT数据（Excel格式）
   - 准备面料顶破实验数据

3. **操作步骤**
   - 在左侧面板选择输入文件
   - 设置材质参数和影响因子
   - 点击"运行分析"开始处理
   - 在右侧视图中查看分析结果

## 系统配置

### 文件路径配置
系统使用以下默认路径：
- 被试足部扫描模型：`C:/Users/wufan/Documents/MyFiles/3 研究院文件/项目文件/足鞋工效2024/2项目研发相关材料/3虚拟适配相关材料/虚拟适配250325/Foot_Model`
- 被试足部标记点文件：`C:/Users/wufan/Documents/MyFiles/3 研究院文件/项目文件/足鞋工效2024/2项目研发相关材料/3虚拟适配相关材料/虚拟适配250325/Foot_Point`
- PPT数据依附模型：`C:/Users/wufan/Documents/MyFiles/3 研究院文件/项目文件/足鞋工效2024/2项目研发相关材料/3虚拟适配相关材料/虚拟适配250325/PPT_Model`
- PPT数据文件：`C:/Users/wufan/Documents/MyFiles/3 研究院文件/项目文件/足鞋工效2024/2项目研发相关材料/3虚拟适配相关材料/虚拟适配250325/PPT_Data`
- 鞋内腔模型：`C:/Users/wufan/Documents/MyFiles/3 研究院文件/项目文件/足鞋工效2024/2项目研发相关材料/3虚拟适配相关材料/虚拟适配250325/Shoe_Model`

### 鞋内腔顶点组划分
系统将鞋内腔划分为7个顶点组：
- 鞋舌上部 (tongue_upper)
- 鞋舌下部 (tongue_lower)
- 鞋尖 (toe)
- 鞋面 (upper)
- 后跟上部 (heel_upper)
- 后跟下部 (heel_lower)
- 鞋底 (sole)

## 注意事项

1. 确保所有输入文件格式正确
2. 运行前检查系统环境配置
3. 大型模型处理可能需要较长时间
4. 建议定期保存分析结果
5. 确保鞋内腔模型中的顶点组名称与系统配置匹配

## 开发团队

- 开发单位：XXX
- 联系方式：XXX

## 版本历史

- v1.0.1 (2024-03-25)
  - 更新鞋内腔顶点组划分
  - 移除材质属性定义
  - 优化系统配置结构

- v1.0.0 (2024-03-25)
  - 初始版本发布
  - 实现基本功能
  - 优化用户界面

# 足部与鞋内腔干涉分析程序

## 1. 程序功能
该程序用于分析和可视化足部模型与鞋内腔模型之间的干涉关系，主要功能包括：
- 计算足部模型与鞋内腔模型之间的干涉/间隙距离
- 使用颜色云图直观显示干涉/间隙分布
- 显示网格面之间的法向量连线
- 支持交互式查看（旋转、缩放、平移）

## 2. 环境要求

### 2.1 依赖库
```python
vtk          # VTK可视化工具包
numpy        # 数值计算库
trimesh      # 3D模型处理库
scipy        # 科学计算库（用于KD树）
```

### 2.2 输入文件要求
- 足部模型：STL格式（默认路径：`C:\Users\wufan\Desktop\适配测试\foot-R.stl`）
- 鞋内腔模型：OBJ格式（默认路径：`C:\Users\wufan\Desktop\适配测试\shoe-R.obj`）

## 3. 主要功能模块

### 3.1 干涉距离计算（compute_interference）
- **计算原理**：使用射线投影法计算干涉距离
- **距离定义**：
  - 负值：表示干涉（足部在鞋内腔内部）
  - 正值：表示间隙（足部在鞋内腔外部）
  - 阈值范围：±25mm
- **计算流程**：
  1. 从足部模型面中心发射法向量射线
  2. 计算射线与鞋内腔的交点
  3. 根据交点数量判断内外位置
  4. 计算最近交点距离
  5. 将面的距离映射到顶点

### 3.2 可视化显示（display_model_with_interference）
- **显示内容**：
  1. 足部模型（不透明）
  2. 鞋内腔模型（半透明）
  3. 干涉云图
  4. 法向量连线
  5. 颜色条

- **颜色映射**：
  - 干涉区域（负值）：红色到白色
  - 间隙区域（正值）：白色到蓝色
  - 范围：±25mm

- **法向量连线**：
  - 起点：鞋内腔面中心点
  - 终点：最近的足部模型面中心点
  - 连线条件：距离 < 25mm
  - 连线颜色：与干涉云图对应
  - 方向判定：
    - 同向（夹角<90度）：干涉，距离为负值
    - 反向（夹角>90度）：间隙，距离为正值

## 4. 使用说明

### 4.1 运行程序
```bash
python test_display.py
```

### 4.2 交互操作
- 鼠标左键：旋转模型
- 鼠标中键：平移模型
- 鼠标右键/滚轮：缩放模型

### 4.3 输出信息
程序运行时会显示以下信息：
- 总顶点数
- 有效顶点数（在±25mm范围内）
- 干涉距离范围

## 5. 注意事项
1. 确保输入模型的完整性和方向正确性
2. 法向量方向定义：
   - 足部模型法向量：指向外部
   - 鞋内腔模型法向量：指向内部
3. 距离阈值（±25mm）可根据需要在代码中调整
4. 连线显示密度可通过修改距离阈值调整

## 6. 可能的改进方向
1. 添加命令行参数支持自定义：
   - 输入文件路径
   - 距离阈值
   - 显示参数
2. 优化性能：
   - 并行计算干涉距离
   - 优化空间查询结构
3. 增强可视化：
   - 支持截面查看
   - 添加测量工具
   - 支持导出分析结果

## 7. 错误处理
程序包含基本的错误处理机制：
- 文件加载错误提示
- 计算过程异常捕获
- 无效数据处理（NaN值处理） 