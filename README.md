# 虚拟足鞋适配系统

## 项目简介
虚拟足鞋适配系统是一个基于Python开发的工具，用于模拟和分析足部与鞋内腔之间的适配情况。该系统通过导入足部三维扫描模型、鞋内腔模型、PPT数据以及面料顶破实验数据，计算并可视化足鞋之间的干涉和压力分布，提供专业的足鞋适配分析。

## 系统架构
系统由以下主要模块组成：

### 1. 数据模型模块 (`models.py`)
- `FootModel`：足部模型类，处理足部三维扫描数据
- `ShoeLast`：鞋内腔模型类，处理鞋内腔模型数据
- `PPTData`：PPT数据类，处理全足疼痛敏感性数据

### 2. 配准模块 (`registration.py`)
- 实现模型之间的配准功能
- 处理特征点对齐
- 坐标变换和数据映射

### 3. 适配分析模块 (`fitting_process.py`)
- 计算足部与鞋内腔之间的干涉
- 分析压力分布
- 生成适配评估结果

### 4. 可视化模块 (`visualization.py`)
- 3D模型渲染
- 压力分布云图显示
- 交互式视图控制

### 5. 用户界面模块 (`gui.py`)
- 基于PyQt5的图形界面
- 左侧控制面板
- 右侧四分屏显示区域
- 实时日志显示

### 6. 主程序模块 (`main.py`)
- 系统初始化和协调
- 数据加载和处理
- 分析流程控制

## 功能特点

1. **数据导入**
   - 支持WRL格式的足部三维扫描模型
   - 支持带有顶点组信息的鞋内腔模型
   - 支持Excel格式的PPT数据
   - 支持面料顶破实验数据

2. **模型对齐**
   - 基于特征点的初始对齐
   - 精确的模型配准
   - 保持足部模型坐标系不变

3. **适配分析**
   - 鞋底区域形态分析
   - 足部模型变形计算
   - 干涉分析和压力计算
   - PPT数据映射和插值

4. **可视化显示**
   - 四视图显示（PPT分布、基础适配、材质优化、最终结果）
   - 交互式3D视图控制
   - 压力分布云图
   - 实时日志显示

## 环境要求
- Python 3.6+
- PyQt5
- VTK
- NumPy
- SciPy
- Pandas
- Trimesh

## 使用说明

1. **启动程序**
   ```bash
   python start.py
   ```

2. **数据准备**
   - 准备足部三维扫描模型（WRL格式）
   - 准备鞋内腔模型（OBJ格式）
   - 准备PPT数据（Excel格式）
   - 准备面料顶破实验数据

3. **操作步骤**
   - 在左侧面板选择输入文件
   - 设置材质参数和影响因子
   - 点击"运行分析"开始处理
   - 在右侧视图中查看分析结果

## 系统配置

### 文件路径配置
系统使用以下默认路径：
- 被试足部扫描模型：`C:/Users/wufan/Documents/MyFiles/3 研究院文件/项目文件/足鞋工效2024/2项目研发相关材料/3虚拟适配相关材料/虚拟适配250325/Foot_Model`
- 被试足部标记点文件：`C:/Users/wufan/Documents/MyFiles/3 研究院文件/项目文件/足鞋工效2024/2项目研发相关材料/3虚拟适配相关材料/虚拟适配250325/Foot_Point`
- PPT数据依附模型：`C:/Users/wufan/Documents/MyFiles/3 研究院文件/项目文件/足鞋工效2024/2项目研发相关材料/3虚拟适配相关材料/虚拟适配250325/PPT_Model`
- PPT数据文件：`C:/Users/wufan/Documents/MyFiles/3 研究院文件/项目文件/足鞋工效2024/2项目研发相关材料/3虚拟适配相关材料/虚拟适配250325/PPT_Data`
- 鞋内腔模型：`C:/Users/wufan/Documents/MyFiles/3 研究院文件/项目文件/足鞋工效2024/2项目研发相关材料/3虚拟适配相关材料/虚拟适配250325/Shoe_Model`

### 鞋内腔顶点组划分
系统将鞋内腔划分为7个顶点组：
- 鞋舌上部 (tongue_upper)
- 鞋舌下部 (tongue_lower)
- 鞋尖 (toe)
- 鞋面 (upper)
- 后跟上部 (heel_upper)
- 后跟下部 (heel_lower)
- 鞋底 (sole)

## 注意事项
1. 确保所有输入文件格式正确
2. 运行前检查系统环境配置
3. 大型模型处理可能需要较长时间
4. 建议定期保存分析结果
5. 确保鞋内腔模型中的顶点组名称与系统配置匹配

## 开发团队
- 开发单位：Fan
- 联系方式：wufanspecial@outlook.com

## 版本历史
- v1.0.1 (2024-03-25)
  - 更新鞋内腔顶点组划分
  - 移除材质属性定义
  - 优化系统配置结构

- v1.0.0 (2024-03-25)
  - 初始版本发布
  - 实现基本功能
  - 优化用户界面

# 足部与鞋内腔干涉分析程序

## 1. 程序功能
该程序用于分析和可视化足部模型与鞋内腔模型之间的干涉关系，主要功能包括：
- 基于网格密度的模型简化
- 计算足部模型与鞋内腔模型之间的干涉/间隙距离
- 使用jet颜色方案显示距离云图
- 显示网格面之间的法向连接线
- 支持交互式查看（旋转、缩放、平移）

## 2. 环境要求

### 2.1 依赖库
```python
vtk          # VTK可视化工具包
numpy        # 数值计算库
trimesh      # 3D模型处理库
scipy        # 科学计算库（用于KD树）
```

### 2.2 输入文件要求
- 足部模型：STL格式（默认路径：`C:\Users\wufan\Desktop\适配测试\foot-R.stl`）
- 鞋内腔模型：OBJ格式（默认路径：`C:\Users\wufan\Desktop\适配测试\shoe-R.obj`）

## 3. 主要功能模块

### 3.1 模型简化（simplify_to_target_density）
- **功能**：将鞋内腔模型简化到与足部模型相近的网格密度
- **输入**：
  - 原始鞋内腔模型
  - 目标网格密度（基于足部模型）
- **输出**：简化后的鞋内腔模型
- **处理流程**：
  1. 计算原始模型的网格密度
  2. 根据目标密度计算简化比例
  3. 使用四边形简化算法进行模型简化
  4. 保持模型表面积基本不变

### 3.2 距离计算（compute_distances）
- **功能**：计算足部模型到鞋内腔的最短距离
- **计算流程**：
  1. 构建鞋内腔面片的KD树
  2. 对每个足部面片：
     - 查找最近的鞋内腔面片
     - 计算两个面片中心点之间的距离
     - 根据距离范围进行过滤
- **距离范围**：
  - 最小值：-12.5mm（小于此值显示为浅灰色）
  - 最大值：25.0mm
  - 有效距离会显示对应颜色
  - 超出范围的区域显示为浅灰色

### 3.3 可视化显示（display_model_with_distances）
- **显示内容**：
  1. 足部模型的距离云图
  2. 网格面之间的法向连接线
  3. 颜色条（显示距离范围）

- **颜色映射**：
  - 使用jet颜色方案
  - 负值（干涉）：从蓝色过渡到青色、绿色
  - 正值（间隙）：从黄色过渡到红色
  - 超出范围：浅灰色

- **连接线显示**：
  - 起点：足部面片中心点
  - 终点：最近的鞋内腔面片中心点
  - 仅显示有效距离范围内的连接线
  - 连接线颜色与距离云图对应

## 4. 使用说明

### 4.1 运行程序
```bash
python test_display.py
```

### 4.2 输出信息
程序运行时会显示：
1. 原始模型信息：
   - 面片数
   - 表面积
   - 网格密度
2. 简化结果：
   - 简化前后的面片数
   - 网格密度变化
   - 表面积保持情况
3. 距离计算结果：
   - 总面片数
   - 有效面片数
   - 距离范围

### 4.3 交互操作
- 鼠标左键：旋转模型
- 鼠标中键：平移模型
- 鼠标右键/滚轮：缩放模型

## 5. 注意事项
1. 确保输入模型的完整性
2. 模型简化会保持表面积基本不变
3. 距离计算考虑了有效范围限制
4. 连接线显示可能会较密集
5. 程序会自动处理无效区域

## 6. 备份说明
- 程序已备份为`deviation_analysis_backup.py`
- 备份文件包含完整的偏差分析功能
- 可用作后续开发的基础版本
- 建议在`test_display.py`上继续开发新功能

## 7. 错误处理
程序包含基本的错误处理机制：
- 文件加载错误提示
- 计算过程异常捕获
- 无效数据处理（NaN值处理）

## 材料拟合方程
每个试样对应的材料拟合方程如下：

### 试样1 - 鞋面
F = -0.0089x⁴ + 0.4375x³ - 3.0884x² + 8.2764x - 3.3784
- R² = 0.9992
- RMSE = 8.35
- 变异系数 (CV): 10.94%
- 稳定性评估: Fair

### 试样2 - 鞋尖
F = -0.0122x⁴ + 0.4174x³ + 1.9400x² - 11.9956x + 8.7726
- R² = 0.9970
- RMSE = 38.57
- 变异系数 (CV): 6.47%
- 稳定性评估: Good

### 试样3
F = -0.0123x⁴ + 0.4421x³ - 2.0785x² + 1.8870x + 1.0934
- R² = 0.9944
- RMSE = 18.85
- 变异系数 (CV): 15.26%
- 稳定性评估: Poor

### 试样4 - 鞋舌下部
F = -0.0107x⁴ + 0.4648x³ - 1.5420x² - 2.8860x + 5.6783
- R² = 0.9991
- RMSE = 14.09
- 变异系数 (CV): 4.20%
- 稳定性评估: Excellent

### 试样5 - 后跟上部
F = -0.0067x⁴ + 0.4720x³ - 6.3526x² + 27.9414x - 20.6310
- R² = 0.9972
- RMSE = 34.59
- 变异系数 (CV): 4.61%
- 稳定性评估: Excellent

### 试样6 - 后跟下部
F = -0.0140x⁴ + 0.5468x³ - 0.9791x² - 5.9761x + 8.0921
- R² = 0.9978
- RMSE = 31.73
- 变异系数 (CV): 4.11%
- 稳定性评估: Excellent

### 试样7 - 鞋舌上部
F = -0.0084x⁴ + 0.4342x³ - 3.7214x² + 8.8407x - 1.5163
- R² = 0.9985
- RMSE = 17.84
- 变异系数 (CV): 9.29%
- 稳定性评估: Good

注：
1. 所有方程中F为力值（N），x为位移值（mm）
2. 试样3的数据稳定性较差（CV > 15%），建议谨慎使用
3. 所有拟合方程的R²值均大于0.99，表明拟合效果优秀
4. 这些方程可以直接在适配程序中调用，用于计算不同位移下的力值
5. 变异系数（CV）反映了测试数据的离散程度，CV越小表示数据稳定性越好

## 偏差分析功能更新说明

### 新增功能：鼠标悬停显示偏差值
在偏差分析模块中，新增了鼠标悬停实时显示局部偏差值的功能。具体实现方法如下：

```python
# 1. 创建文本显示器
text_actor = vtk.vtkTextActor()
text_actor.GetTextProperty().SetFontSize(14)
text_actor.GetTextProperty().SetBold(True)
text_actor.GetTextProperty().SetColor(0, 0, 0)  # 黑色文字
text_actor.SetPosition(10, 10)
renderer.AddActor2D(text_actor)

# 2. 创建拾取器
picker = vtk.vtkCellPicker()
picker.SetTolerance(0.001)

# 3. 创建鼠标移动回调函数
def mouse_move_callback(obj, event):
    try:
        # 获取鼠标位置
        x, y = obj.GetEventPosition()
        
        # 拾取点
        picker.Pick(x, y, 0, renderer)
        
        if picker.GetCellId() != -1:
            # 获取拾取的面片
            cell_id = picker.GetCellId()
            cell = polydata.GetCell(cell_id)
            
            # 获取面片顶点的距离值
            point_ids = [cell.GetPointId(i) for i in range(3)]
            point_distances = [distance_data.GetValue(pid) for pid in point_ids]
            
            # 计算平均距离值
            distance_value = np.mean(point_distances)
            
            # 显示距离值
            if not np.isnan(distance_value):
                text_actor.SetInput(f"距离值: {distance_value:.2f} mm")
            else:
                text_actor.SetInput("距离值: N/A")
        else:
            text_actor.SetInput("")
        
        renderer.GetRenderWindow().Render()
        
    except Exception as e:
        print(f"鼠标回调函数出错: {str(e)}")
        text_actor.SetInput("")
        renderer.GetRenderWindow().Render()

# 4. 添加事件观察者
interactor.AddObserver("MouseMoveEvent", mouse_move_callback)
```

### 功能特点
1. 实时显示：
   - 鼠标移动到模型表面时实时显示当前位置的偏差值
   - 显示值为当前面片三个顶点的平均偏差值
   - 数值精确到小数点后两位

2. 显示位置：
   - 偏差值显示在窗口左上角
   - 使用黑色粗体字体，清晰易读
   - 当鼠标移出模型表面时自动隐藏

3. 错误处理：
   - 对无效区域显示"N/A"
   - 包含完整的异常处理机制
   - 出错时不影响程序继续运行

### 使用说明
1. 在显示偏差云图时，直接将鼠标移动到感兴趣的区域
2. 窗口左上角会实时显示该位置的偏差值
3. 正值表示间隙，负值表示干涉
4. 超出有效范围的区域会显示"N/A"

### 注意事项
1. 显示的偏差值是面片三个顶点的平均值
2. 对于网格密度较低的区域，显示值可能存在一定误差
3. 确保模型加载正确且计算完成后再使用此功能

## 测试人员鞋码信息
系统测试人员（S1-S21）的试穿鞋码如下：
- S1：35，36
- S2：36，37
- S3：36，37
- S4：36，37
- S5：35，36
- S6：42，43
- S7：42，43
- S8：42，43
- S9：41，42
- S10：42，43
- S11：41，42
- S12：42，43
- S13：42，43
- S14：41，42
- S15：41，42
- S16：39，40F
- S17：35，36
- S18：37，38
- S19：40F，41
- S20：36，37
- S21：43，44

## 鞋码分布统计
各鞋码对应的测试人员分布如下：

### 35码
- S1
- S5
- S17

### 36码
- S1
- S2
- S3
- S4
- S5
- S17
- S20

### 37码
- S2
- S3
- S4
- S18
- S20

### 38码
- S18

### 39码
- S16

### 40F码
- S16
- S19

40M
S15

### 41码
- S9
- S11
- S14
- S15
- S19

### 42码
- S6
- S7
- S8
- S9
- S10
- S12
- S13

### 43码
- S6
- S7
- S8
- S10
- S12
- S13
- S21

### 44码
- S21

### 统计说明
1. 最受欢迎的鞋码是42码和43码，各有7位测试人员试穿
2. 36码和37码次之，分别有7位和5位测试人员试穿
3. 35码、41码和40F码各有3位测试人员试穿
4. 38码、39码和44码只有1位测试人员试穿
5. 有些测试人员会试穿相邻的两个尺码，这是为了找到最合适的尺码 